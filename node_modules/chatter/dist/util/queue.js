'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Queue = function () {
  function Queue() {
    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    (0, _classCallCheck3.default)(this, Queue);

    this.cache = {};
    var _options$onDrain = options.onDrain,
        onDrain = _options$onDrain === undefined ? function (data) {
      return console.log('onDrain', data);
    } : _options$onDrain;

    this.onDrain = onDrain;
  }

  (0, _createClass3.default)(Queue, [{
    key: 'enqueue',
    value: function enqueue(id, data) {
      if (!this.cache[id]) {
        this.cache[id] = {
          queue: []
        };
      }
      var obj = this.cache[id];
      obj.queue.push(data);
      if (!obj.promise) {
        obj.promise = this.drain(id);
      }
      return obj.promise;
    }
  }, {
    key: 'drain',
    value: function drain(id) {
      var _this = this;

      var obj = this.cache[id];
      var next = function next() {
        if (obj.queue.length === 0) {
          obj.promise = null;
          return null;
        }
        return _bluebird2.default.try(function () {
          return _this.onDrain(id, obj.queue.shift());
        }).then(next);
      };
      return next();
    }
  }]);
  return Queue;
}();

exports.default = Queue;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3F1ZXVlLmpzIl0sIm5hbWVzIjpbIlF1ZXVlIiwib3B0aW9ucyIsImNhY2hlIiwib25EcmFpbiIsImNvbnNvbGUiLCJsb2ciLCJkYXRhIiwiaWQiLCJxdWV1ZSIsIm9iaiIsInB1c2giLCJwcm9taXNlIiwiZHJhaW4iLCJuZXh0IiwibGVuZ3RoIiwidHJ5Iiwic2hpZnQiLCJ0aGVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOzs7Ozs7SUFFcUJBLEs7QUFFbkIsbUJBQTBCO0FBQUEsUUFBZEMsT0FBYyx1RUFBSixFQUFJO0FBQUE7O0FBQ3hCLFNBQUtDLEtBQUwsR0FBYSxFQUFiO0FBRHdCLDJCQUlwQkQsT0FKb0IsQ0FHdEJFLE9BSHNCO0FBQUEsUUFHdEJBLE9BSHNCLG9DQUdaO0FBQUEsYUFBUUMsUUFBUUMsR0FBUixDQUFZLFNBQVosRUFBdUJDLElBQXZCLENBQVI7QUFBQSxLQUhZOztBQUt4QixTQUFLSCxPQUFMLEdBQWVBLE9BQWY7QUFDRDs7Ozs0QkFFT0ksRSxFQUFJRCxJLEVBQU07QUFDaEIsVUFBSSxDQUFDLEtBQUtKLEtBQUwsQ0FBV0ssRUFBWCxDQUFMLEVBQXFCO0FBQ25CLGFBQUtMLEtBQUwsQ0FBV0ssRUFBWCxJQUFpQjtBQUNmQyxpQkFBTztBQURRLFNBQWpCO0FBR0Q7QUFDRCxVQUFNQyxNQUFNLEtBQUtQLEtBQUwsQ0FBV0ssRUFBWCxDQUFaO0FBQ0FFLFVBQUlELEtBQUosQ0FBVUUsSUFBVixDQUFlSixJQUFmO0FBQ0EsVUFBSSxDQUFDRyxJQUFJRSxPQUFULEVBQWtCO0FBQ2hCRixZQUFJRSxPQUFKLEdBQWMsS0FBS0MsS0FBTCxDQUFXTCxFQUFYLENBQWQ7QUFDRDtBQUNELGFBQU9FLElBQUlFLE9BQVg7QUFDRDs7OzBCQUVLSixFLEVBQUk7QUFBQTs7QUFDUixVQUFNRSxNQUFNLEtBQUtQLEtBQUwsQ0FBV0ssRUFBWCxDQUFaO0FBQ0EsVUFBTU0sT0FBTyxTQUFQQSxJQUFPLEdBQU07QUFDakIsWUFBSUosSUFBSUQsS0FBSixDQUFVTSxNQUFWLEtBQXFCLENBQXpCLEVBQTRCO0FBQzFCTCxjQUFJRSxPQUFKLEdBQWMsSUFBZDtBQUNBLGlCQUFPLElBQVA7QUFDRDtBQUNELGVBQU8sbUJBQVFJLEdBQVIsQ0FBWTtBQUFBLGlCQUFNLE1BQUtaLE9BQUwsQ0FBYUksRUFBYixFQUFpQkUsSUFBSUQsS0FBSixDQUFVUSxLQUFWLEVBQWpCLENBQU47QUFBQSxTQUFaLEVBQXVEQyxJQUF2RCxDQUE0REosSUFBNUQsQ0FBUDtBQUNELE9BTkQ7QUFPQSxhQUFPQSxNQUFQO0FBQ0Q7Ozs7O2tCQWxDa0JiLEsiLCJmaWxlIjoicXVldWUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFF1ZXVlIHtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmNhY2hlID0ge307XG4gICAgY29uc3Qge1xuICAgICAgb25EcmFpbiA9IGRhdGEgPT4gY29uc29sZS5sb2coJ29uRHJhaW4nLCBkYXRhKSxcbiAgICB9ID0gb3B0aW9ucztcbiAgICB0aGlzLm9uRHJhaW4gPSBvbkRyYWluO1xuICB9XG5cbiAgZW5xdWV1ZShpZCwgZGF0YSkge1xuICAgIGlmICghdGhpcy5jYWNoZVtpZF0pIHtcbiAgICAgIHRoaXMuY2FjaGVbaWRdID0ge1xuICAgICAgICBxdWV1ZTogW10sXG4gICAgICB9O1xuICAgIH1cbiAgICBjb25zdCBvYmogPSB0aGlzLmNhY2hlW2lkXTtcbiAgICBvYmoucXVldWUucHVzaChkYXRhKTtcbiAgICBpZiAoIW9iai5wcm9taXNlKSB7XG4gICAgICBvYmoucHJvbWlzZSA9IHRoaXMuZHJhaW4oaWQpO1xuICAgIH1cbiAgICByZXR1cm4gb2JqLnByb21pc2U7XG4gIH1cblxuICBkcmFpbihpZCkge1xuICAgIGNvbnN0IG9iaiA9IHRoaXMuY2FjaGVbaWRdO1xuICAgIGNvbnN0IG5leHQgPSAoKSA9PiB7XG4gICAgICBpZiAob2JqLnF1ZXVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBvYmoucHJvbWlzZSA9IG51bGw7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UudHJ5KCgpID0+IHRoaXMub25EcmFpbihpZCwgb2JqLnF1ZXVlLnNoaWZ0KCkpKS50aGVuKG5leHQpO1xuICAgIH07XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuXG59XG4iXX0=
