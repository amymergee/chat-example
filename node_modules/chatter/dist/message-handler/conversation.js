'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ConversingMessageHandler = undefined;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

exports.default = createConversation;

var _processMessage = require('../util/process-message');

var _delegate = require('./delegate');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var ConversingMessageHandler = exports.ConversingMessageHandler = function (_DelegatingMessageHan) {
  (0, _inherits3.default)(ConversingMessageHandler, _DelegatingMessageHan);

  function ConversingMessageHandler() {
    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    var children = arguments[1];
    (0, _classCallCheck3.default)(this, ConversingMessageHandler);

    var _this = (0, _possibleConstructorReturn3.default)(this, (ConversingMessageHandler.__proto__ || (0, _getPrototypeOf2.default)(ConversingMessageHandler)).call(this, options, children));

    _this.dialog = null;
    _this.hasState = true;
    return _this;
  }

  // If a child handler yields an object with a "dialog" property, that
  // handler will be stored and will receive the next message. Upon receiving
  // that next message, the dialog will then be cleared.
  //
  // A stored dialog may yield another dialog (ad infinitum). If no dialog is
  // stored, child handlers will be called. A copy of the object yielded by the
  // child handler / dialog (minus the dialog property) will be yielded.


  (0, _createClass3.default)(ConversingMessageHandler, [{
    key: 'handleMessage',
    value: function handleMessage(message) {
      var _this2 = this;

      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      return _processMessage.processMessage.apply(undefined, [this.dialog || this.children, message].concat(args)).finally(function () {
        return _this2.clearDialog();
      }).then(function (data) {
        if (data && data.dialog) {
          _this2.dialog = data.dialog;
          data = (0, _assign2.default)({}, data);
          delete data.dialog;
        }
        return data;
      });
    }

    // Forceably clear any current stored dialog.

  }, {
    key: 'clearDialog',
    value: function clearDialog() {
      this.dialog = null;
    }
  }]);
  return ConversingMessageHandler;
}(_delegate.DelegatingMessageHandler);

function createConversation() {
  for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
    args[_key2] = arguments[_key2];
  }

  return new (Function.prototype.bind.apply(ConversingMessageHandler, [null].concat(args)))();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tZXNzYWdlLWhhbmRsZXIvY29udmVyc2F0aW9uLmpzIl0sIm5hbWVzIjpbImNyZWF0ZUNvbnZlcnNhdGlvbiIsIkNvbnZlcnNpbmdNZXNzYWdlSGFuZGxlciIsIm9wdGlvbnMiLCJjaGlsZHJlbiIsImRpYWxvZyIsImhhc1N0YXRlIiwibWVzc2FnZSIsImFyZ3MiLCJmaW5hbGx5IiwiY2xlYXJEaWFsb2ciLCJ0aGVuIiwiZGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztrQkFzQ3dCQSxrQjs7QUF0Q3hCOztBQUNBOzs7O0lBRWFDLHdCLFdBQUFBLHdCOzs7QUFFWCxzQ0FBb0M7QUFBQSxRQUF4QkMsT0FBd0IsdUVBQWQsRUFBYztBQUFBLFFBQVZDLFFBQVU7QUFBQTs7QUFBQSwwS0FDNUJELE9BRDRCLEVBQ25CQyxRQURtQjs7QUFFbEMsVUFBS0MsTUFBTCxHQUFjLElBQWQ7QUFDQSxVQUFLQyxRQUFMLEdBQWdCLElBQWhCO0FBSGtDO0FBSW5DOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7OztrQ0FDY0MsTyxFQUFrQjtBQUFBOztBQUFBLHdDQUFOQyxJQUFNO0FBQU5BLFlBQU07QUFBQTs7QUFDOUIsYUFBTyxpREFBZSxLQUFLSCxNQUFMLElBQWUsS0FBS0QsUUFBbkMsRUFBNkNHLE9BQTdDLFNBQXlEQyxJQUF6RCxHQUNKQyxPQURJLENBQ0k7QUFBQSxlQUFNLE9BQUtDLFdBQUwsRUFBTjtBQUFBLE9BREosRUFFSkMsSUFGSSxDQUVDLGdCQUFRO0FBQ1osWUFBSUMsUUFBUUEsS0FBS1AsTUFBakIsRUFBeUI7QUFDdkIsaUJBQUtBLE1BQUwsR0FBY08sS0FBS1AsTUFBbkI7QUFDQU8saUJBQU8sc0JBQWMsRUFBZCxFQUFrQkEsSUFBbEIsQ0FBUDtBQUNBLGlCQUFPQSxLQUFLUCxNQUFaO0FBQ0Q7QUFDRCxlQUFPTyxJQUFQO0FBQ0QsT0FUSSxDQUFQO0FBVUQ7O0FBRUQ7Ozs7a0NBQ2M7QUFDWixXQUFLUCxNQUFMLEdBQWMsSUFBZDtBQUNEOzs7OztBQUlZLFNBQVNKLGtCQUFULEdBQXFDO0FBQUEscUNBQU5PLElBQU07QUFBTkEsUUFBTTtBQUFBOztBQUNsRCw0Q0FBV04sd0JBQVgsZ0JBQXVDTSxJQUF2QztBQUNEIiwiZmlsZSI6ImNvbnZlcnNhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7cHJvY2Vzc01lc3NhZ2V9IGZyb20gJy4uL3V0aWwvcHJvY2Vzcy1tZXNzYWdlJztcbmltcG9ydCB7RGVsZWdhdGluZ01lc3NhZ2VIYW5kbGVyfSBmcm9tICcuL2RlbGVnYXRlJztcblxuZXhwb3J0IGNsYXNzIENvbnZlcnNpbmdNZXNzYWdlSGFuZGxlciBleHRlbmRzIERlbGVnYXRpbmdNZXNzYWdlSGFuZGxlciB7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9ucyA9IHt9LCBjaGlsZHJlbikge1xuICAgIHN1cGVyKG9wdGlvbnMsIGNoaWxkcmVuKTtcbiAgICB0aGlzLmRpYWxvZyA9IG51bGw7XG4gICAgdGhpcy5oYXNTdGF0ZSA9IHRydWU7XG4gIH1cblxuICAvLyBJZiBhIGNoaWxkIGhhbmRsZXIgeWllbGRzIGFuIG9iamVjdCB3aXRoIGEgXCJkaWFsb2dcIiBwcm9wZXJ0eSwgdGhhdFxuICAvLyBoYW5kbGVyIHdpbGwgYmUgc3RvcmVkIGFuZCB3aWxsIHJlY2VpdmUgdGhlIG5leHQgbWVzc2FnZS4gVXBvbiByZWNlaXZpbmdcbiAgLy8gdGhhdCBuZXh0IG1lc3NhZ2UsIHRoZSBkaWFsb2cgd2lsbCB0aGVuIGJlIGNsZWFyZWQuXG4gIC8vXG4gIC8vIEEgc3RvcmVkIGRpYWxvZyBtYXkgeWllbGQgYW5vdGhlciBkaWFsb2cgKGFkIGluZmluaXR1bSkuIElmIG5vIGRpYWxvZyBpc1xuICAvLyBzdG9yZWQsIGNoaWxkIGhhbmRsZXJzIHdpbGwgYmUgY2FsbGVkLiBBIGNvcHkgb2YgdGhlIG9iamVjdCB5aWVsZGVkIGJ5IHRoZVxuICAvLyBjaGlsZCBoYW5kbGVyIC8gZGlhbG9nIChtaW51cyB0aGUgZGlhbG9nIHByb3BlcnR5KSB3aWxsIGJlIHlpZWxkZWQuXG4gIGhhbmRsZU1lc3NhZ2UobWVzc2FnZSwgLi4uYXJncykge1xuICAgIHJldHVybiBwcm9jZXNzTWVzc2FnZSh0aGlzLmRpYWxvZyB8fCB0aGlzLmNoaWxkcmVuLCBtZXNzYWdlLCAuLi5hcmdzKVxuICAgICAgLmZpbmFsbHkoKCkgPT4gdGhpcy5jbGVhckRpYWxvZygpKVxuICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEuZGlhbG9nKSB7XG4gICAgICAgICAgdGhpcy5kaWFsb2cgPSBkYXRhLmRpYWxvZztcbiAgICAgICAgICBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgZGF0YSk7XG4gICAgICAgICAgZGVsZXRlIGRhdGEuZGlhbG9nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgfSk7XG4gIH1cblxuICAvLyBGb3JjZWFibHkgY2xlYXIgYW55IGN1cnJlbnQgc3RvcmVkIGRpYWxvZy5cbiAgY2xlYXJEaWFsb2coKSB7XG4gICAgdGhpcy5kaWFsb2cgPSBudWxsO1xuICB9XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlQ29udmVyc2F0aW9uKC4uLmFyZ3MpIHtcbiAgcmV0dXJuIG5ldyBDb252ZXJzaW5nTWVzc2FnZUhhbmRsZXIoLi4uYXJncyk7XG59XG4iXX0=
